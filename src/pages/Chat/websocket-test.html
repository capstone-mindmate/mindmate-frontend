<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>WebSocket ì±„íŒ… í…ŒìŠ¤íŠ¸</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; }
        .form-group input, .form-group textarea { width: 100%; padding: 8px; box-sizing: border-box; }
        button { padding: 8px 15px; margin-right: 10px; cursor: pointer; }
        #log { height: 300px; overflow-y: scroll; border: 1px solid #ccc; padding: 10px; margin-top: 20px; background-color: #f5f5f5; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        .warning { color: orange; }
        .flex-container { display: flex; justify-content: space-between; }
        .col { flex: 1; margin: 0 10px; }
        .message-container { border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; border-radius: 5px; }
        .message-sender { font-weight: bold; }
        .message-time { font-size: 0.8em; color: #666; }
        .message-content { margin-top: 5px; }
        .read-status { font-size: 0.8em; color: #666; text-align: right; }
        .online-status { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 5px; }
        .online { background-color: green; }
        .offline { background-color: gray; }
        .reaction-container { display: flex; margin-top: 5px; }
        .reaction-button { margin-right: 5px; cursor: pointer; padding: 2px 5px; border-radius: 3px; background-color: #f0f0f0; }
        .reaction-button.active { background-color: #d1e7ff; }
        .reaction-count { margin-left: 3px; font-size: 0.8em; }
        .custom-form { background-color: #f5f5f5; padding: 10px; border-radius: 5px; margin-top: 10px; }
        .custom-form-header { font-weight: bold; margin-bottom: 5px; }
        .custom-form-question { margin-bottom: 5px; }
        .custom-form-answer { margin-left: 15px; color: #0066cc; }
        .custom-form-input { width: 100%; padding: 5px; margin-bottom: 5px; }
        .toast-box {
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin: 10px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            overflow: hidden;
            max-width: 100%;
            opacity: 1; /* ê¸°ë³¸ê°’ì„ 1ë¡œ ë³€ê²½ */
            z-index: 10; /* z-index ì¶”ê°€ */
            position: relative; /* position ì†ì„± ì¶”ê°€ */
        }
        
        .toast-box-header {
            background-color: #f8f9fa;
            padding: 8px 12px;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .toast-box-title {
            font-weight: bold;
            color: #0066cc;
        }
        
        .toast-box-close {
            cursor: pointer;
            font-size: 18px;
            color: #666;
        }
        
        .toast-box-content {
            padding: 10px 12px;
            color: #333;
        }
        
        .toast-box-footer {
            padding: 8px 12px;
            border-top: 1px solid #eee;
            text-align: right;
        }
        
        .toast-box-link {
            color: #0066cc;
            text-decoration: none;
            font-size: 0.9em;
        }
        
        .toast-box-link:hover {
            text-decoration: underline;
        }
        
        .toast-box-image {
            padding: 0 12px 12px;
            text-align: center;
        }
        
        .toast-box-image img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 3px;
        }
        
        /* í•„í„°ë§ëœ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ ê°œì„  */
        .message-container[data-message-type="FILTERED"] {
            position: relative;
        }
        
        .message-container[data-message-type="FILTERED"] .message-content {
            color: #721c24;
            background-color: #f8d7da;
            padding: 8px 12px;
            border-radius: 5px;
            border-left: 3px solid #f5c6cb;
            margin: 5px 0;
            font-style: italic;
        }
        
        .message-container[data-message-type="FILTERED"]::before {
            content: '';
            position: absolute;
            top: 0;
            left: -5px;
            width: 3px;
            height: 100%;
            background-color: #f5c6cb;
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .emoticon-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }
        
        .emoticon-item {
            width: 60px;
            height: 60px;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            overflow: hidden;
            transition: transform 0.2s;
        }
        
        .emoticon-item:hover {
            transform: scale(1.1);
            border-color: #0066cc;
        }
        
        .emoticon-item img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        #emoticonBtn {
            background-color: #f8f9fa;
        }
        
        #emoticonBtn:hover {
            background-color: #e9ecef;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>WebSocket ì±„íŒ… í…ŒìŠ¤íŠ¸</h1>
    
    <!-- í•˜ë‹¨ë°” ì¶”ê°€ -->
    <div style="position: fixed; bottom: 0; left: 0; width: 100%; background-color: #f8f9fa; padding: 10px; border-top: 1px solid #ddd; display: flex; justify-content: space-between; z-index: 100;">
        <div>
            <strong>ì´ ì½ì§€ ì•Šì€ ë©”ì‹œì§€:</strong> <span id="totalUnreadCount" style="color: #dc3545; font-weight: bold;">0</span>
        </div>
        <div>
            <button onclick="fetchTotalUnreadCount()" style="padding: 5px 10px;">ìƒˆë¡œê³ ì¹¨</button>
        </div>
    </div>
    
    <div class="flex-container">
        <div class="col">
            <div class="form-group">
                <label for="token">JWT í† í°:</label>
                <input type="text" id="token" placeholder="JWT í† í°" value="ì—¬ê¸°ì— JWT í† í° ì…ë ¥">
            </div>
            
            <div>
                <button onclick="connect()">ì—°ê²°</button>
                <button onclick="disconnect()">ì—°ê²° í•´ì œ</button>
            </div>
            
            <div class="form-group" style="margin-top: 20px;">
                <label for="roomId">ì±„íŒ…ë°© ID:</label>
                <input type="text" id="roomId" placeholder="ì±„íŒ…ë°© ID" value="1">
                <button onclick="subscribe()">ì±„íŒ…ë°© ì…ì¥</button>
                <button onclick="unsubscribe()">ì±„íŒ…ë°© í‡´ì¥</button>
            </div>
            
            <div class="form-group">
                <label for="message">ë©”ì‹œì§€:</label>
                <textarea id="message" placeholder="ë³´ë‚¼ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”" rows="3"></textarea>
                <div class="button-group">
                    <button id="emoticonBtn" onclick="toggleEmoticonPanel()">ğŸ˜Š ì´ëª¨í‹°ì½˜</button>
                    <button onclick="sendMessage()">ì „ì†¡</button>
                </div>
            </div>
            
            <!-- ì´ëª¨í‹°ì½˜ ì„ íƒ íŒ¨ë„ -->
            <div id="emoticonPanel" style="display:none; border: 1px solid #ccc; padding: 10px; margin-top: 10px; background-color: white; border-radius: 5px;">
                <div class="emoticon-header">
                    <h4>ë‚´ ì´ëª¨í‹°ì½˜</h4>
                    <span onclick="toggleEmoticonPanel()" style="cursor:pointer; float:right;">Ã—</span>
                </div>
                <div id="emoticonContainer" class="emoticon-container">
                    <p>ì´ëª¨í‹°ì½˜ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>
            </div>
            
            <div class="form-group">
                <button onclick="markAsRead()">ì½ìŒ ì²˜ë¦¬</button>
                <button onclick="fetchMessages()">ë©”ì‹œì§€ ì¡°íšŒ (REST)</button>
                <button onclick="fetchChatRooms()">ì±„íŒ…ë°© ëª©ë¡ ì¡°íšŒ</button>
                <button onclick="showCustomFormCreator()">ì»¤ìŠ¤í…€í¼ ìƒì„±</button>
            </div>
            
            <!-- ì»¤ìŠ¤í…€í¼ ìƒì„± UI -->
            <div id="customFormCreator" style="display:none; margin-top: 15px; border: 1px solid #ccc; padding: 10px; border-radius: 5px;">
                <h3>ì»¤ìŠ¤í…€í¼ ìƒì„±</h3>
                <div id="questionContainer">
                    <div class="form-group">
                        <input type="text" class="custom-form-input" placeholder="ì§ˆë¬¸ 1">
                    </div>
                </div>
                <button onclick="addQuestion()">ì§ˆë¬¸ ì¶”ê°€</button>
                <button onclick="createCustomForm()">í¼ ìƒì„±</button>
                <button onclick="cancelCustomForm()">ì·¨ì†Œ</button>
            </div>
        </div>
        
        <div class="col">
            <h3>ì±„íŒ…ë°© ì •ë³´</h3>
            <div id="roomInfo">
                <p>ì±„íŒ…ë°©: <span id="currentRoomDisplay">ì—†ìŒ</span></p>
                <p>ì°¸ê°€ì ìƒíƒœ:</p>
                <ul id="participantStatus">
                    <li>ì°¸ê°€ì ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</li>
                </ul>
                <p>ì½ì§€ ì•Šì€ ë©”ì‹œì§€: <span id="unreadCount">0</span></p>
            </div>
            
            <h3>ë©”ì‹œì§€</h3>
            <div id="messages"></div>
        </div>
    </div>
    
    <h3>ë¡œê·¸</h3>
    <div id="log"></div>
</div>

<script>
    let stompClient = null;
    let currentRoomId = null;
    let subscriptions = {};
    let userId = null;
    let messages = [];
    let participants = {};
    let baseUrl = 'http://localhost:8080';
    let heartbeatInterval;

    // ê°ì •í‘œí˜„ ì´ëª¨ì§€ ë§¤í•‘
    const reactionEmojis = {
        'LIKE': 'ğŸ‘',
        'HEART': 'â¤ï¸',
        'LAUGH': 'ğŸ˜‚',
        'SAD': 'ğŸ˜¢',
        'ANGRY': 'ğŸ˜¡'
    };

    function connect() {
        const token = document.getElementById('token').value;
        if (!token) {
            logMessage("í† í°ì„ ì…ë ¥í•´ì£¼ì„¸ìš”", "error");
            return;
        }
    
        const socket = new SockJS(baseUrl + '/ws');
        stompClient = Stomp.over(socket);
        stompClient.debug = null;
        
        logMessage("ì—°ê²° ì‹œë„ ì¤‘...", "info");
        stompClient.connect(
            { 'Authorization': 'Bearer ' + token },
            function(frame) {
                logMessage('ì—°ê²° ì„±ê³µ: ' + frame, "success");
                
                try {
                    const base64Url = token.split('.')[1];
                    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                    const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                    }).join(''));
                    const payload = JSON.parse(jsonPayload);
                    userId = payload.userId || payload.sub;
                    logMessage(`ì‚¬ìš©ì ID: ${userId}`, "info");
                } catch (e) {
                    logMessage('í† í°ì—ì„œ ì‚¬ìš©ì IDë¥¼ ì¶”ì¶œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + e, "warning");
                }
                
                // ì•Œë¦¼ ë° ë¯¸ì½ìŒ ë©”ì‹œì§€ ì¹´ìš´íŠ¸ êµ¬ë…
                subscriptions['notification'] = stompClient.subscribe('/user/queue/notification', handleNotification);
                subscriptions['unread'] = stompClient.subscribe('/user/queue/unread', updateUnreadCount);
                subscriptions['totalUnread'] = stompClient.subscribe('/user/queue/total-unread', updateTotalUnreadCount);
                
                updatePresence('ONLINE');
                startHeartbeat();
                fetchTotalUnreadCount();
            },
            function(error) {
                logMessage('ì—°ê²° ì˜¤ë¥˜: ' + error, "error");
            }
        );
    }

    function disconnect() {
        if (heartbeatInterval) clearInterval(heartbeatInterval);
        if (stompClient !== null) {
            updatePresence('OFFLINE');
            Object.values(subscriptions).forEach(sub => {
                try {
                    sub.unsubscribe();
                } catch (e) {}
            });
            subscriptions = {};
            
            stompClient.disconnect();
            logMessage('ì—°ê²°ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤', "info");
            stompClient = null;
            currentRoomId = null;
            updateRoomDisplay();
        }
    }

    function subscribe() {
        if (!stompClient) {
            logMessage("ë¨¼ì € ì—°ê²°ì„ í•´ì£¼ì„¸ìš”", "error");
            return;
        }
        
        if (currentRoomId) {
            unsubscribeRoom(currentRoomId);
        }
        
        currentRoomId = document.getElementById('roomId').value;
        
        logMessage(`ì±„íŒ…ë°© ${currentRoomId} êµ¬ë… ì¤‘...`, "info");
        
        // ë‹¨ì¼ ì±„ë„ë¡œ ëª¨ë“  ë©”ì‹œì§€ ìˆ˜ì‹  (Redis Pub/Sub ë°©ì‹ ë³€ê²½ ë°˜ì˜)
        subscriptions[`room_${currentRoomId}`] = stompClient.subscribe(
            '/topic/chat.room.' + currentRoomId,
            handleIncomingMessage
        );
        
        // ì´ë²¤íŠ¸ë³„ êµ¬ë… ì¶”ê°€ (Redis Pub/Sub ë³€ê²½ì— ë§ì¶° ì¶”ê°€)
        subscriptions[`read_${currentRoomId}`] = stompClient.subscribe(
            '/topic/chat.room.' + currentRoomId + '.read',
            handleReadStatus
        );
        
        subscriptions[`reaction_${currentRoomId}`] = stompClient.subscribe(
            '/topic/chat.room.' + currentRoomId + '.reaction',
            handleReactionEvent
        );
        
        subscriptions[`customform_${currentRoomId}`] = stompClient.subscribe(
            '/topic/chat.room.' + currentRoomId + '.customform',
            handleCustomFormEvent
        );
        
        subscriptions[`toastbox_${currentRoomId}`] = stompClient.subscribe(
            '/topic/chat.room.' + currentRoomId + '.toastbox',
            handleToastBoxEvent
        );
        
        subscriptions[`emoticon_${currentRoomId}`] = stompClient.subscribe(
            '/topic/chat.room.' + currentRoomId + '.emoticon',
            handleEmoticonMessage
        );
    
        updatePresence('ONLINE', currentRoomId);
        markAsRead();
        fetchMessages();
        updateRoomDisplay();
        logMessage(`ì±„íŒ…ë°© ${currentRoomId} êµ¬ë… ì™„ë£Œ`, "success");
    }
    
    function unsubscribeRoom(roomId) {
        ['room', 'read', 'reaction', 'customform', 'toastbox', 'emoticon'].forEach(type => {
            const subKey = `${type}_${roomId}`;
            if (subscriptions[subKey]) {
                try {
                    subscriptions[subKey].unsubscribe();
                    delete subscriptions[subKey];
                } catch (e) {
                    logMessage(`êµ¬ë… í•´ì œ ì˜¤ë¥˜ (${type}): ${e}`, "error");
                }
            }
        });
    }

    function unsubscribe() {
        if (!currentRoomId) {
            logMessage("í˜„ì¬ êµ¬ë… ì¤‘ì¸ ì±„íŒ…ë°©ì´ ì—†ìŠµë‹ˆë‹¤", "warning");
            return;
        }
        
        unsubscribeRoom(currentRoomId);
        updatePresence('ONLINE', null);
        currentRoomId = null;
        updateRoomDisplay();
        document.getElementById('messages').innerHTML = '';
        logMessage("ì±„íŒ…ë°©ì—ì„œ í‡´ì¥í–ˆìŠµë‹ˆë‹¤", "info");
    }
    
    // ì´ ì½ì§€ ì•Šì€ ë©”ì‹œì§€ ìˆ˜ ì—…ë°ì´íŠ¸ í•¸ë“¤ëŸ¬
    function updateTotalUnreadCount(message) {
        try {
            const data = JSON.parse(message.body);
            const totalCount = data.totalUnreadCount;
            
            document.getElementById('totalUnreadCount').textContent = totalCount;
            
            logMessage(`ì´ ì½ì§€ ì•Šì€ ë©”ì‹œì§€: ${totalCount}ê°œ`, "info");
        } catch (e) {
            console.error("Error processing total unread count:", e);
        }
    }
    
    // ì´ˆê¸° ì´ ì½ì§€ ì•Šì€ ë©”ì‹œì§€ ìˆ˜ ì¡°íšŒ
    function fetchTotalUnreadCount() {
        const token = document.getElementById('token').value;
        if (!token) {
            logMessage("í† í°ì„ ì…ë ¥í•´ì£¼ì„¸ìš”", "error");
            return;
        }
        
        logMessage("ì´ ì½ì§€ ì•Šì€ ë©”ì‹œì§€ ìˆ˜ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤...", "info");
        
        fetch(`${baseUrl}/chat/unread/total`, {
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) throw new Error('ì´ ì½ì§€ ì•Šì€ ë©”ì‹œì§€ ìˆ˜ ì¡°íšŒ ì‹¤íŒ¨: ' + response.status);
            return response.json();
        })
        .then(count => {
            document.getElementById('totalUnreadCount').textContent = count;
            logMessage(`ì´ ì½ì§€ ì•Šì€ ë©”ì‹œì§€ ìˆ˜: ${count}ê°œ`, "success");
        })
        .catch(error => logMessage('ì´ ì½ì§€ ì•Šì€ ë©”ì‹œì§€ ìˆ˜ ì¡°íšŒ ì˜¤ë¥˜: ' + error.message, "error"));
    }

    
    // ì´ëª¨í‹°ì½˜ ë©”ì‹œì§€ ì²˜ë¦¬
    function handleEmoticonMessage(message) {
        try {
            const data = JSON.parse(message.body);
            console.log("Emoticon message:", data);
    
            const emoticonMessage = {
                id: data.messageId,
                senderId: data.senderId,
                senderName: data.senderName,
                emoticonUrl: data.emoticonUrl,     // ì´ í•„ë“œ!
                emoticonName: data.emoticonName,   // ì´ í•„ë“œ!
                createdAt: data.timestamp,
                type: 'EMOTICON'
            };
    
            addMessageToDisplay(emoticonMessage);
            logMessage(`ì´ëª¨í‹°ì½˜ ë©”ì‹œì§€ê°€ ìˆ˜ì‹ ë˜ì—ˆìŠµë‹ˆë‹¤: ${data.emoticonName}`, "info");
        } catch (e) {
            console.error("Error processing emoticon message:", e);
        }
    }

    
    // ì´ëª¨í‹°ì½˜ íŒ¨ë„ í† ê¸€
    function toggleEmoticonPanel() {
        const panel = document.getElementById('emoticonPanel');
        if (panel.style.display === 'none') {
            panel.style.display = 'block';
            fetchEmoticons();
        } else {
            panel.style.display = 'none';
        }
    }
    
    // ì‚¬ìš© ê°€ëŠ¥í•œ ì´ëª¨í‹°ì½˜ ì¡°íšŒ
    function fetchEmoticons() {
        const token = document.getElementById('token').value;
        if (!token) {
            logMessage("í† í°ì„ ì…ë ¥í•´ì£¼ì„¸ìš”", "error");
            return;
        }
        
        logMessage("ì‚¬ìš© ê°€ëŠ¥í•œ ì´ëª¨í‹°ì½˜ì„ ì¡°íšŒí•©ë‹ˆë‹¤...", "info");
        
        fetch(`${baseUrl}/emoticons/available`, {
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) throw new Error('ì´ëª¨í‹°ì½˜ ì¡°íšŒ ì‹¤íŒ¨: ' + response.status);
            return response.json();
        })
        .then(emoticons => {
            displayEmoticons(emoticons);
            logMessage(`${emoticons.length}ê°œì˜ ì´ëª¨í‹°ì½˜ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤`, "success");
        })
        .catch(error => logMessage('ì´ëª¨í‹°ì½˜ ì¡°íšŒ ì˜¤ë¥˜: ' + error.message, "error"));
    }
    
    // ì´ëª¨í‹°ì½˜ í‘œì‹œ
    function displayEmoticons(emoticons) {
        const container = document.getElementById('emoticonContainer');
        
        if (!emoticons || emoticons.length === 0) {
            container.innerHTML = '<p>ì‚¬ìš© ê°€ëŠ¥í•œ ì´ëª¨í‹°ì½˜ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }
        
        container.innerHTML = '';
        
        emoticons.forEach(emoticon => {
        console.log('emoticon:', emoticon);
            const emoticonElement = document.createElement('div');
            emoticonElement.className = 'emoticon-item';
            emoticonElement.onclick = () => sendEmoticon(emoticon.id);
            
            const img = document.createElement('img');
            img.src = `http://localhost:8080${emoticon.imageUrl}`;
            img.alt = emoticon.name;
            img.title = emoticon.name;
            
            emoticonElement.appendChild(img);
            container.appendChild(emoticonElement);
        });
    }
    
    // ì´ëª¨í‹°ì½˜ ì „ì†¡
    function sendEmoticon(emoticonId) {
        if (!stompClient || !currentRoomId) {
            logMessage("ë¨¼ì € ì±„íŒ…ë°©ì— ì…ì¥í•´ì£¼ì„¸ìš”", "error");
            return;
        }
        
        const emoticonRequest = {
            roomId: currentRoomId,
            emoticonId: emoticonId
        };
        
        logMessage(`ì´ëª¨í‹°ì½˜ ì „ì†¡ ì¤‘: ${JSON.stringify(emoticonRequest)}`, "info");
        stompClient.send('/app/chat.emoticon', {}, JSON.stringify(emoticonRequest));
        
        // ì´ëª¨í‹°ì½˜ íŒ¨ë„ ë‹«ê¸°
        document.getElementById('emoticonPanel').style.display = 'none';
    }

    function sendMessage() {
        if (!stompClient || !currentRoomId) {
            logMessage("ë¨¼ì € ì±„íŒ…ë°©ì— ì…ì¥í•´ì£¼ì„¸ìš”", "error");
            return;
        }
        
        const messageContent = document.getElementById('message').value;
        if (!messageContent) {
            logMessage("ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”", "error");
            return;
        }
        
        const chatMessage = {
            roomId: currentRoomId,
            content: messageContent,
            type: 'TEXT'
        };
        
        logMessage(`ë©”ì‹œì§€ ì „ì†¡ ì¤‘: ${JSON.stringify(chatMessage)}`, "info");
        stompClient.send('/app/chat.send', {}, JSON.stringify(chatMessage));
        
        document.getElementById('message').value = '';
    }

    function markAsRead() {
        if (!stompClient || !currentRoomId) {
            logMessage("ì±„íŒ…ë°©ì— ì…ì¥í•œ ìƒíƒœì—ì„œë§Œ ì½ìŒ ì²˜ë¦¬ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤", "warning");
            return;
        }
        
        const readRequest = { roomId: currentRoomId };
        stompClient.send('/app/chat.read', {}, JSON.stringify(readRequest));
        logMessage(`ì±„íŒ…ë°© ${currentRoomId}ì˜ ë©”ì‹œì§€ë¥¼ ì½ìŒ ì²˜ë¦¬í–ˆìŠµë‹ˆë‹¤`, "info");
    }

    function fetchMessages() {
        if (!currentRoomId) {
            logMessage("ë¨¼ì € ì±„íŒ…ë°©ì„ ì„ íƒí•´ì£¼ì„¸ìš”", "warning");
            return;
        }
        
        const token = document.getElementById('token').value;
        if (!token) {
            logMessage("í† í°ì„ ì…ë ¥í•´ì£¼ì„¸ìš”", "error");
            return;
        }
        
        logMessage(`ì±„íŒ…ë°© ${currentRoomId}ì˜ ë©”ì‹œì§€ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤...`, "info");
        
        fetch(`${baseUrl}/chat/rooms/${currentRoomId}/messages?page=0&size=20`, {
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) throw new Error('ë©”ì‹œì§€ ì¡°íšŒ ì‹¤íŒ¨: ' + response.status);
            return response.json();
        })
        .then(data => {
            logMessage(`ë©”ì‹œì§€ ì¡°íšŒ ì„±ê³µ: ${data.messages.length}ê°œì˜ ë©”ì‹œì§€`, "success");
            displayMessages(data);
            updateParticipantStatus(data);
        })
        .catch(error => logMessage('ë©”ì‹œì§€ ì¡°íšŒ ì˜¤ë¥˜: ' + error.message, "error"));
    }

    function fetchChatRooms() {
        const token = document.getElementById('token').value;
        if (!token) {
            logMessage("í† í°ì„ ì…ë ¥í•´ì£¼ì„¸ìš”", "error");
            return;
        }
        
        logMessage("ì±„íŒ…ë°© ëª©ë¡ì„ ì¡°íšŒí•©ë‹ˆë‹¤...", "info");
        
        fetch(`${baseUrl}/chat/rooms?page=0&size=10`, {
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) throw new Error('ì±„íŒ…ë°© ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨: ' + response.status);
            return response.json();
        })
        .then(data => {
            logMessage(`ì±„íŒ…ë°© ëª©ë¡ ì¡°íšŒ ì„±ê³µ: ${data.content.length}ê°œì˜ ì±„íŒ…ë°©`, "success");
            displayChatRooms(data);
        })
        .catch(error => logMessage('ì±„íŒ…ë°© ëª©ë¡ ì¡°íšŒ ì˜¤ë¥˜: ' + error.message, "error"));
    }
function handleIncomingMessage(message) {
    try {
        const data = JSON.parse(message.body);
        console.log("Received message on main channel:", data);

        // ì´ë²¤íŠ¸ íƒ€ì…ì´ ìˆëŠ” ê²½ìš° ì²˜ë¦¬ (Redis Pub/Sub ì´ë²¤íŠ¸ í˜•ì‹)
         if (data.type && data.data) {
            switch (data.type) {
                case 'MESSAGE':
                    // ì¼ë°˜ ë©”ì‹œì§€ ì²˜ë¦¬
                    addMessageToDisplay(data.data);
                    return;
                case 'READ_STATUS':
                    handleReadStatus({ body: JSON.stringify(data.data) });
                    return;
                case 'REACTION':
                    handleReactionEvent({ body: JSON.stringify(data.data) });
                    return;
                case 'CUSTOM_FORM':
                case 'CUSTOM_FORM_RESPONSE':
                    handleCustomFormEvent({ body: JSON.stringify(data.data) });
                    return;
                case 'TOAST_BOX':
                    handleToastBoxEvent({ body: JSON.stringify(data.data) });
                    return;
                case 'CONTENT_FILTERED':
                    // í•„í„°ë§ëœ ë©”ì‹œì§€ ì²˜ë¦¬
                    addMessageToDisplay(data.data);
                    return;
                 case 'EMOTICON':
                    // ì´ëª¨í‹°ì½˜ ë©”ì‹œì§€ ì²˜ë¦¬
                    handleEmoticonMessage({ body: JSON.stringify(data.data) });
                    return;
            }
        }

        // ì´ì „ í˜•ì‹ í˜¸í™˜ì„± ìœ ì§€ (type í•„ë“œê°€ ì—†ëŠ” ê²½ìš°)
        if (data.id !== undefined) { // nullë„ í—ˆìš©í•˜ë„ë¡ ë³€ê²½
            addMessageToDisplay(data);
        } else if (data.messageId && data.keyword) {
            // í† ìŠ¤íŠ¸ ë°•ìŠ¤ ì´ë²¤íŠ¸ ì²˜ë¦¬
            handleToastBoxEvent({ body: JSON.stringify(data) });
        } else {
            console.error("Invalid message format:", data);
        }
    } catch (e) {
        console.error("Error processing message:", e, message.body);
    }
}
function handleToastBoxEvent(message) {
    try {
        const toastData = JSON.parse(message.body);
        console.log("Toast box event:", toastData);
        
        if (toastData.roomId && toastData.messageId && toastData.keyword) {
            // ê´€ë ¨ ë©”ì‹œì§€ ì°¾ê¸°
            const messageElement = document.querySelector(`.message-container[data-message-id="${toastData.messageId}"]`);
            
            if (messageElement) {
                // ì´ë¯¸ í† ìŠ¤íŠ¸ ë°•ìŠ¤ê°€ ìˆëŠ”ì§€ í™•ì¸
                const existingToastBox = messageElement.querySelector(`.toast-box[data-keyword="${toastData.keyword}"]`);
                if (!existingToastBox) {
                    // í† ìŠ¤íŠ¸ ë°•ìŠ¤ UI ìƒì„±
                    const toastBoxElement = createToastBoxElement(toastData);
                    
                    // ë©”ì‹œì§€ ë‚´ìš© ë‹¤ìŒì— í† ìŠ¤íŠ¸ ë°•ìŠ¤ ì¶”ê°€
                    const messageContent = messageElement.querySelector('.message-content');
                    messageContent.insertAdjacentElement('afterend', toastBoxElement);
                    
                    // í† ìŠ¤íŠ¸ ë°•ìŠ¤ ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼ - ì¦‰ì‹œ .show í´ë˜ìŠ¤ ì¶”ê°€
                    toastBoxElement.classList.add('show');
                    
                    // ì½˜ì†”ì— ë¡œê·¸ ì¶”ê°€
                    console.log("Toast box added and show class applied:", toastBoxElement);
                    
                    logMessage(`í† ìŠ¤íŠ¸ ë°•ìŠ¤ê°€ í‘œì‹œë¨: í‚¤ì›Œë“œ "${toastData.keyword}"`, "info");
                }
            } else {
                logMessage(`ë©”ì‹œì§€ ID ${toastData.messageId}ì— ëŒ€í•œ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤`, "warning");
            }
        } else {
            console.error("Invalid toast box format:", toastData);
        }
    } catch (e) {
        console.error("Error processing toast box:", e);
    }
}


function createToastBoxElement(toastData) {
    const toastBox = document.createElement('div');
    toastBox.className = 'toast-box';
    toastBox.dataset.keyword = toastData.keyword;
    
    let toastContent = `
        <div class="toast-box-header">
            <span class="toast-box-title">${toastData.title || 'ì •ë³´'}</span>
            <span class="toast-box-close" onclick="this.parentNode.parentNode.remove()">Ã—</span>
        </div>
        <div class="toast-box-content">
            ${toastData.content || ''}
        </div>
    `;
    
    if (toastData.linkUrl) {
        toastContent += `
            <div class="toast-box-footer">
                <a href="${toastData.linkUrl}" target="_blank" class="toast-box-link">ìì„¸íˆ ë³´ê¸°</a>
            </div>
        `;
    }
    
    if (toastData.imageUrl) {
        toastContent += `
            <div class="toast-box-image">
                <img src="${toastData.imageUrl}" alt="${toastData.keyword}">
            </div>
        `;
    }
    
    toastBox.innerHTML = toastContent;
    return toastBox;
}





// ì•Œë¦¼ í•¸ë“¤ëŸ¬
function handleNotification(message) {
    try {
        const notification = JSON.parse(message.body);
        console.log("Notification received:", notification);
        
        // ì•Œë¦¼ íƒ€ì…ì— ë”°ë¥¸ ì²˜ë¦¬
        if (notification.type === 'NEW_MESSAGE') {
            // ìƒˆ ë©”ì‹œì§€ ì•Œë¦¼
            logMessage(`ìƒˆ ë©”ì‹œì§€ ì•Œë¦¼: ì±„íŒ…ë°© ${notification.roomId}ì— ìƒˆ ë©”ì‹œì§€ê°€ ìˆìŠµë‹ˆë‹¤`, "info");
        } else if (notification.type === 'ROOM_STATUS') {
            // ì±„íŒ…ë°© ìƒíƒœ ë³€ê²½ ì•Œë¦¼
            logMessage(`ì±„íŒ…ë°© ìƒíƒœ ë³€ê²½: ì±„íŒ…ë°© ${notification.roomId}ì˜ ìƒíƒœê°€ ${notification.status}ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤`, "info");
        } else {
            logMessage(`ì•Œë¦¼: ${JSON.stringify(notification)}`, "info");
        }
    } catch (e) {
        console.error("Error processing notification:", e, message.body);
    }
}
    
    function updatePresence(status, activeRoomId = currentRoomId) {
        if (stompClient && stompClient.connected) {
            stompClient.send('/app/presence', {},
                JSON.stringify({
                    status: status,
                    activeRoomId: activeRoomId
                })
            );
            logMessage(`ì‚¬ìš©ì ìƒíƒœê°€ ${status}ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`, "info");
        }
    }

// ë¯¸ì½ìŒ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸ í•¸ë“¤ëŸ¬
function updateUnreadCount(message) {
    const unreadData = JSON.parse(message.body);
    const roomId = unreadData.roomId;
    const count = unreadData.unreadCount;
    
    if (roomId === currentRoomId) {
        document.getElementById('unreadCount').textContent = count;
    }
    
    logMessage(`ì±„íŒ…ë°© ${roomId}ì˜ ì½ì§€ ì•Šì€ ë©”ì‹œì§€: ${count}ê°œ`, "info");
}
    
    function updateUnreadCount(message) {
        const unreadData = JSON.parse(message.body);
        const roomId = unreadData.roomId;
        const count = unreadData.unreadCount;
        
        if (roomId === currentRoomId) {
            document.getElementById('unreadCount').textContent = count;
        }
        
        logMessage(`ì±„íŒ…ë°© ${roomId}ì˜ ì½ì§€ ì•Šì€ ë©”ì‹œì§€: ${count}ê°œ`, "info");
    }
    
// ì½ìŒ ìƒíƒœ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
function handleReadStatus(message) {
    try {
        const readData = JSON.parse(message.body);
        console.log("Read status update:", readData);

        // ReadStatusNotification êµ¬ì¡°ì— ë§ê²Œ ì²˜ë¦¬
        if (readData.roomId && readData.userId && readData.timestamp) {
            const messagesDiv = document.getElementById('messages');
            const messageElements = messagesDiv.querySelectorAll('.message-container');

            messageElements.forEach(element => {
                const readStatus = element.querySelector('.read-status');
                if (readStatus && element.dataset.roomId === String(readData.roomId)) {
                    readStatus.textContent = 'ì½ìŒ';
                }
            });

            logMessage(`ì‚¬ìš©ì ${readData.userId}ê°€ ì±„íŒ…ë°© ${readData.roomId}ì˜ ë©”ì‹œì§€ë¥¼ ì½ì—ˆìŠµë‹ˆë‹¤`, "info");
        } else {
            console.error("Invalid read status format:", readData);
        }
    } catch (e) {
        console.error("Error processing read status:", e);
    }
}


// ê°ì •í‘œí˜„ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
function handleReactionEvent(message) {
    try {
        const data = JSON.parse(message.body);
        console.log("Reaction data:", data);

        // MessageReactionResponse êµ¬ì¡°ì— ë§ê²Œ ì²˜ë¦¬
        if (data.messageId) {
            const messageId = data.messageId;
            const messageElement = document.querySelector(`.message-container[data-message-id="${messageId}"]`);

            if (messageElement) {
                // ì‚¬ìš©ìê°€ ê°ì •í‘œí˜„ì„ ì œê±°í•œ ê²½ìš° (idê°€ nullì¸ ê²½ìš°)
                if (data.id === null && data.userId == userId) {
                    // í•´ë‹¹ íƒ€ì…ì˜ ë²„íŠ¼ì—ì„œ active í´ë˜ìŠ¤ ì œê±°
                    const reactionType = data.reactionType;
                    const reactionButton = messageElement.querySelector(`.reaction-button[onclick*="${reactionType}"]`);
                    
                    if (reactionButton) {
                        reactionButton.classList.remove('active');
                        // ì¹´ìš´íŠ¸ ê°ì†Œ
                        const countSpan = reactionButton.querySelector('.reaction-count');
                        let count = parseInt(countSpan.textContent || '0');
                        count = Math.max(0, count - 1);
                        countSpan.textContent = count > 0 ? count : '';
                    }
                }
                // ìƒˆ ê°ì •í‘œí˜„ ì¶”ê°€ ë˜ëŠ” ë³€ê²½
                else if (data.id !== null) {
                    const reactionType = data.reactionType;
                    
                    // í˜„ì¬ ì‚¬ìš©ìì˜ ë°˜ì‘ì¸ ê²½ìš°, ì´ì „ active ìƒíƒœ ì œê±° ë° ìƒˆ ë²„íŠ¼ active ì„¤ì •
                    if (data.userId == userId) {
                        // ì´ì „ì— active ìƒíƒœì˜€ë˜ ë²„íŠ¼ ì°¾ê¸°
                        const previousActive = messageElement.querySelector('.reaction-button.active');
                        if (previousActive) {
                            // ì´ì „ ë²„íŠ¼ì˜ active ì œê±° ë° ì¹´ìš´íŠ¸ ê°ì†Œ
                            previousActive.classList.remove('active');
                            const prevCountSpan = previousActive.querySelector('.reaction-count');
                            let prevCount = parseInt(prevCountSpan.textContent || '0');
                            prevCount = Math.max(0, prevCount - 1);
                            prevCountSpan.textContent = prevCount > 0 ? prevCount : '';
                        }
                        
                        // ìƒˆ ë²„íŠ¼ active ì„¤ì •
                        const reactionButton = messageElement.querySelector(`.reaction-button[onclick*="${reactionType}"]`);
                        if (reactionButton) {
                            reactionButton.classList.add('active');
                            // ì¹´ìš´íŠ¸ ì¦ê°€
                            const countSpan = reactionButton.querySelector('.reaction-count');
                            let count = parseInt(countSpan.textContent || '0');
                            count += 1;
                            countSpan.textContent = count > 0 ? count : '';
                        }
                    }
                    // ë‹¤ë¥¸ ì‚¬ìš©ìì˜ ë°˜ì‘ì¸ ê²½ìš°, í•´ë‹¹ ë²„íŠ¼ì˜ ì¹´ìš´íŠ¸ë§Œ ì¦ê°€
                    else {
                        const reactionButton = messageElement.querySelector(`.reaction-button[onclick*="${reactionType}"]`);
                        if (reactionButton) {
                            const countSpan = reactionButton.querySelector('.reaction-count');
                            let count = parseInt(countSpan.textContent || '0');
                            count += 1;
                            countSpan.textContent = count > 0 ? count : '';
                        }
                    }
                }
                
                logMessage(`${data.userName || 'ì‚¬ìš©ì'}ë‹˜ì´ ë©”ì‹œì§€ ${messageId}ì— ${data.reactionType} ë°˜ì‘ì„ ${data.id === null ? 'ì œê±°' : 'ì¶”ê°€'}í–ˆìŠµë‹ˆë‹¤`, "info");
            } else {
                logMessage(`ë©”ì‹œì§€ ID ${messageId}ì— ëŒ€í•œ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤`, "warning");
                fetchMessages(); // ë©”ì‹œì§€ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            }
        } else {
            console.error("Invalid reaction format:", data);
        }
    } catch (e) {
        console.error("Error processing reaction:", e);
    }
}


// ì»¤ìŠ¤í…€í¼ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
function handleCustomFormEvent(message) {
    try {
        const formData = JSON.parse(message.body);
        console.log("Custom form data:", formData);
        
        // CustomFormResponse êµ¬ì¡°ì— ë§ê²Œ ì²˜ë¦¬
        if (formData.id && formData.chatRoomId && formData.creatorId) {
            if (!formData.isAnswered) {
                // ìƒˆ ì»¤ìŠ¤í…€í¼ ìƒì„±
                const customFormMessage = {
                    id: `form-${formData.id}`,
                    senderId: formData.creatorId,
                    senderName: formData.creatorName,
                    content: 'ì»¤ìŠ¤í…€í¼ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤',
                    createdAt: formData.createdAt,
                    type: 'CUSTOM_FORM',
                    customForm: formData
                };
                
                addMessageToDisplay(customFormMessage);
                logMessage(`ìƒˆ ì»¤ìŠ¤í…€í¼ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤: ${formData.id}`, "info");
            } else {
                // ì»¤ìŠ¤í…€í¼ ì‘ë‹µ ì²˜ë¦¬
                const formElement = document.querySelector(`.custom-form[data-form-id="${formData.id}"]`);
                
                if (formElement) {
                    // í¼ í—¤ë” ì—…ë°ì´íŠ¸
                    const headerElement = formElement.querySelector('.custom-form-header');
                    if (headerElement) {
                        headerElement.textContent = `ì»¤ìŠ¤í…€í¼ (ì‘ë‹µë¨: ${formData.responderName})`;
                    }
                    
                    // ê° ì§ˆë¬¸ í•­ëª© ì—…ë°ì´íŠ¸
                    formData.items.forEach((item, index) => {
                        const questionElement = formElement.querySelectorAll('.custom-form-question')[index];
                        
                        if (questionElement) {
                            // ì…ë ¥ í•„ë“œ ì œê±° ë° ë‹µë³€ í‘œì‹œ
                            const inputElement = questionElement.nextElementSibling;
                            if (inputElement && inputElement.classList.contains('custom-form-input')) {
                                const answerElement = document.createElement('div');
                                answerElement.className = 'custom-form-answer';
                                answerElement.textContent = item.answer || 'ë‹µë³€ ì—†ìŒ';
                                questionElement.parentNode.insertBefore(answerElement, inputElement.nextSibling);
                                inputElement.remove();
                            }
                        }
                    });
                    
                    // ì‘ë‹µ ë²„íŠ¼ ì œê±°
                    const responseButton = formElement.querySelector('button');
                    if (responseButton) {
                        responseButton.remove();
                    }
                    
                    logMessage(`ì»¤ìŠ¤í…€í¼ ${formData.id}ì— ${formData.responderName}ë‹˜ì´ ì‘ë‹µí–ˆìŠµë‹ˆë‹¤`, "info");
                } else {
                    logMessage(`ì»¤ìŠ¤í…€í¼ ID ${formData.id}ì— ëŒ€í•œ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤`, "warning");
                    fetchMessages(); // ë©”ì‹œì§€ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                }
            }
        } else {
            console.error("Invalid custom form format:", formData);
        }
    } catch (e) {
        console.error("Error processing custom form:", e);
    }
}


    
    function displayMessages(data) {
        const messagesDiv = document.getElementById('messages');
        messagesDiv.innerHTML = '';
        
        if (!data.messages || data.messages.length === 0) {
            messagesDiv.innerHTML = '<p>ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }
        
        messages = data.messages;
        
        messages.forEach(message => {
            addMessageToDisplay(message, false);
        });
        
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
        
function addMessageToDisplay(message, isNew = true) {
    if (!message) {
        console.error("Message object is null or undefined");
        return;
    }

    
    const messagesContainer = document.getElementById('messages');
    const messageElement = document.createElement('div');
    messageElement.className = 'message-container';
    messageElement.dataset.messageId = message.id || `error-${Date.now()}`; // IDê°€ ì—†ëŠ” ê²½ìš° ì„ì‹œ ID ìƒì„±
    messageElement.dataset.messageType = message.type || 'TEXT';
    messageElement.dataset.roomId = currentRoomId;

    const isMyMessage = message.senderId == userId;

    // í•„í„°ë§ëœ ë©”ì‹œì§€ ì²˜ë¦¬
    if (message.filtered) {
        messageElement.dataset.messageType = 'FILTERED';
        // í•„í„°ë§ ì•„ì´ì½˜ ì¶”ê°€
        const filterIcon = 'âš ï¸';
        message.content = `${filterIcon} ${message.content}`;
    }

    // ì—ëŸ¬ ë©”ì‹œì§€ ì²˜ë¦¬
    if (message.error) {
        messageElement.dataset.messageType = 'ERROR';
    }
    
    let messageContent = `
        <div class="message-header">
            <span class="message-sender">${message.senderName || 'ì•Œ ìˆ˜ ì—†ìŒ'} ${isMyMessage ? '(ë‚˜)' : ''}</span>
            <span class="message-time">${formatTime(message.createdAt)}</span>
        </div>
    `;
    
    // ë©”ì‹œì§€ íƒ€ì…ì— ë”°ë¼ ë‹¤ë¥¸ ë‚´ìš© í‘œì‹œ
    if (message.type === 'EMOTICON') {
        let emoticonImgUrl = message.emoticonUrl;
        if (emoticonImgUrl && !emoticonImgUrl.startsWith('http')) {
            emoticonImgUrl = `http://localhost:8080${emoticonImgUrl}`;
        }
        messageContent = `<img src="${emoticonImgUrl}" alt="${message.emoticonName || ''}" class="message-emoticon" style="max-height: 80px; max-width: 80px;">`;
    } else {
        messageContent += `<div class="message-content">${message.content || ''}</div>`;
    }


    // ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
    if (message.error && message.errorMessage) {
        messageContent += `<div class="error-message">${message.errorMessage}</div>`;
    }

    // ì»¤ìŠ¤í…€í¼ ì²˜ë¦¬
    if (message.type === 'CUSTOM_FORM' && message.customForm) {
        const formId = message.customForm.id;
        const isAnswered = message.customForm.isAnswered;
        
        messageContent += `
            <div class="custom-form" data-form-id="${formId}">
                <div class="custom-form-header">${isAnswered ? `ì»¤ìŠ¤í…€í¼ (ì‘ë‹µë¨: ${message.customForm.responderName})` : 'ì»¤ìŠ¤í…€í¼'}</div>
        `;
        
        message.customForm.items.forEach(item => {
            messageContent += `<div class="custom-form-question">${item.question}</div>`;
            
            if (isAnswered) {
                messageContent += `<div class="custom-form-answer">${item.answer || 'ë‹µë³€ ì—†ìŒ'}</div>`;
            } else if (message.senderId != userId) {
                messageContent += `<input type="text" class="custom-form-input" placeholder="ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš”">`;
            } else {
                messageContent += `<div class="custom-form-answer">ëŒ€ê¸° ì¤‘...</div>`;
            }
        });
        
        if (!isAnswered && message.senderId != userId) {
            messageContent += `<button onclick="respondToForm('${formId}')">ì‘ë‹µ ì œì¶œ</button>`;
        }
        
        messageContent += `</div>`;
    } else if (message.type !== 'CUSTOM_FORM') {
        // ì¼ë°˜ ë©”ì‹œì§€ì— ëŒ€í•œ ê°ì •í‘œí˜„ ë²„íŠ¼ ì¶”ê°€
        messageContent += `<div class="reaction-container">`;

        Object.entries(reactionEmojis).forEach(([type, emoji]) => {
            const count = message.reactionCounts && message.reactionCounts[type] ? message.reactionCounts[type] : 0;
            const isActive = message.userReaction === type;

            messageContent += `
                <span class="reaction-button ${isActive ? 'active' : ''}"
                      onclick="addReaction('${message.id}', '${type}')">
                    ${emoji} <span class="reaction-count">${count > 0 ? count : ''}</span>
                </span>
            `;
        });

        messageContent += `</div>`;
    }

    messageContent += `<div class="read-status">${isMyMessage ? 'ì „ì†¡ë¨' : 'ì•ˆì½ìŒ'}</div>`;
    messageElement.innerHTML = messageContent;

    if (isNew) {
        messagesContainer.appendChild(messageElement);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    } else {
        messagesContainer.appendChild(messageElement);
    }
}



    
    function addReaction(messageId, reactionType) {
        if (!stompClient || !currentRoomId) {
            logMessage("ë¨¼ì € ì±„íŒ…ë°©ì— ì…ì¥í•´ì£¼ì„¸ìš”", "error");
            return;
        }
        
        const reactionRequest = {
            messageId: messageId,
            roomId: currentRoomId,
            reactionType: reactionType
        };
        
        stompClient.send('/app/chat.reaction', {}, JSON.stringify(reactionRequest));
        logMessage(`ë©”ì‹œì§€ ${messageId}ì— ${reactionType} ê°ì •í‘œí˜„ì„ ì¶”ê°€í•©ë‹ˆë‹¤`, "info");
    }
    
    function showCustomFormCreator() {
        if (!currentRoomId) {
            logMessage("ë¨¼ì € ì±„íŒ…ë°©ì— ì…ì¥í•´ì£¼ì„¸ìš”", "error");
            return;
        }
        
        document.getElementById('customFormCreator').style.display = 'block';
    }
    
    function addQuestion() {
        const container = document.getElementById('questionContainer');
        const questionCount = container.children.length + 1;
        
        const questionDiv = document.createElement('div');
        questionDiv.className = 'form-group';
        questionDiv.innerHTML = `<input type="text" class="custom-form-input" placeholder="ì§ˆë¬¸ ${questionCount}">`;
        
        container.appendChild(questionDiv);
    }
    
    function createCustomForm() {
        if (!stompClient || !currentRoomId) {
            logMessage("ë¨¼ì € ì±„íŒ…ë°©ì— ì…ì¥í•´ì£¼ì„¸ìš”", "error");
            return;
        }
        
        const questions = [];
        document.querySelectorAll('#questionContainer input').forEach(input => {
            if (input.value.trim()) {
                questions.push(input.value.trim());
            }
        });
        
        if (questions.length === 0) {
            logMessage("ìµœì†Œ í•˜ë‚˜ ì´ìƒì˜ ì§ˆë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”", "error");
            return;
        }
        
        const formRequest = {
            chatRoomId: currentRoomId,
            questions: questions
        };
        
        stompClient.send('/app/chat.customform.create', {}, JSON.stringify(formRequest));
        logMessage(`ì»¤ìŠ¤í…€í¼ì„ ìƒì„±í•©ë‹ˆë‹¤: ${questions.length}ê°œì˜ ì§ˆë¬¸`, "info");
        
        cancelCustomForm();
    }
    
    function cancelCustomForm() {
        document.getElementById('customFormCreator').style.display = 'none';
        document.getElementById('questionContainer').innerHTML = `
            <div class="form-group">
                <input type="text" class="custom-form-input" placeholder="ì§ˆë¬¸ 1">
            </div>
        `;
    }
    
    function respondToForm(formId) {
        if (!stompClient || !currentRoomId) {
            logMessage("ë¨¼ì € ì±„íŒ…ë°©ì— ì…ì¥í•´ì£¼ì„¸ìš”", "error");
            return;
        }
        
        const answers = [];
        document.querySelectorAll(`.custom-form[data-form-id="${formId}"] .custom-form-input`).forEach(input => {
            answers.push(input.value.trim() || "ë‹µë³€ ì—†ìŒ");
        });
        
        if (answers.length === 0) {
            logMessage("ë‹µë³€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”", "error");
            return;
        }
        
        const responseRequest = {
            formId: formId,
            answers: answers
        };
        
        stompClient.send('/app/chat.customform.respond', {}, JSON.stringify(responseRequest));
        logMessage(`ì»¤ìŠ¤í…€í¼ ${formId}ì— ì‘ë‹µí•©ë‹ˆë‹¤`, "info");
    }





    
    function updateParticipantStatus(data) {
        if (!data.participants) return;
        
        participants = data.participants || {};
        const statusList = document.getElementById('participantStatus');
        statusList.innerHTML = '';
        
        Object.entries(participants).forEach(([participantId, participant]) => {
            const li = document.createElement('li');
            const isOnline = participant.online;
            
            li.innerHTML = `
                <span class="online-status ${isOnline ? 'online' : 'offline'}"></span>
                ${participant.name} (${isOnline ? 'ì˜¨ë¼ì¸' : 'ì˜¤í”„ë¼ì¸'})
            `;
            
            statusList.appendChild(li);
        });
    }
    
    function updateRoomDisplay() {
        document.getElementById('currentRoomDisplay').textContent = currentRoomId || 'ì—†ìŒ';
    }
    
    function displayChatRooms(data) {
        const rooms = data.content || [];
        let html = '<h3>ì±„íŒ…ë°© ëª©ë¡</h3><ul>';
        
        rooms.forEach(room => {
            html += `<li>
                <strong>${room.roomName || 'ì±„íŒ…ë°© ' + room.id}</strong>
                (ID: ${room.id}, ìƒíƒœ: ${room.status})
                <button onclick="enterRoom(${room.id})">ì…ì¥</button>
            </li>`;
        });
        
        html += '</ul>';
        
        const logDiv = document.getElementById('log');
        logDiv.innerHTML += html;
        logDiv.scrollTop = logDiv.scrollHeight;
    }
    
    function enterRoom(roomId) {
        document.getElementById('roomId').value = roomId;
        subscribe();
    }
    
    function formatTime(timestamp) {
        if (!timestamp) return '';
        
        const date = new Date(timestamp);
        return date.toLocaleString();
    }
    
    function logMessage(message, type = "info") {
        const logDiv = document.getElementById('log');
        const messageElement = document.createElement('div');
        messageElement.className = type;
        messageElement.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        
        logDiv.appendChild(messageElement);
        logDiv.scrollTop = logDiv.scrollHeight;
    }
    
    function startHeartbeat() {
        if (heartbeatInterval) clearInterval(heartbeatInterval);
        
        heartbeatInterval = setInterval(() => {
            if (stompClient && stompClient.connected) {
                updatePresence(currentRoomId ? 'ONLINE' : 'ONLINE', currentRoomId);
            } else {
                clearInterval(heartbeatInterval);
            }
        }, 30000); // 30ì´ˆë§ˆë‹¤ ìƒíƒœ ì—…ë°ì´íŠ¸
    }
    
    // í˜ì´ì§€ ê°€ì‹œì„± ë³€ê²½ ê°ì§€
    document.addEventListener('visibilitychange', function() {
        // AWAY ëŒ€ì‹  OFFLINE ì‚¬ìš©
        const status = document.hidden ? 'OFFLINE' : 'ONLINE';
        updatePresence(status);
        if (status === 'ONLINE' && currentRoomId) {
            markAsRead();
        }
    });
</script>
</body>
</html>


